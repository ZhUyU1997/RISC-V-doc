<table border="0" height="1453" width="1123">
<tr><td>
<div style="position:absolute;top:74.119;left:132.145;"><nobr>
<span style="font-size:20.022;">52</span>
</nobr></div>
<div style="position:absolute;top:74.119;left:331.141;"><nobr>
<span style="font-size:20.022;font-style:italic;">Volume II: RISC-V Privileged Architectures V20190608-Priv-MSU-Ratified</span>
</nobr></div>
<div style="position:absolute;top:130.572;left:132.145;"><nobr>
<span style="font-size:20.022;">modes. When the L bit is clear, any M-mode access matching the PMP entry will succeed; the</span>
</nobr></div>
<div style="position:absolute;top:155.440;left:132.145;"><nobr>
<span style="font-size:20.022;">R/W/X permissions apply only to S and U modes.</span>
</nobr></div>
<div style="position:absolute;top:227.402;left:132.145;"><nobr>
<span style="font-size:20.022;font-weight:bold;">Priority and Matching Logic</span>
</nobr></div>
<div style="position:absolute;top:283.644;left:132.145;"><nobr>
<span style="font-size:20.022;">PMP entries are statically prioritized. The lowest-numbered PMP entry that matches any byte of</span>
</nobr></div>
<div style="position:absolute;top:308.511;left:132.145;"><nobr>
<span style="font-size:20.022;">an access determines whether that access succeeds or fails. The matching PMP entry must match</span>
</nobr></div>
<div style="position:absolute;top:333.379;left:132.145;"><nobr>
<span style="font-size:20.022;">all bytes of an access, or the access fails, irrespective of the L, R, W, and X bits. For example,</span>
</nobr></div>
<div style="position:absolute;top:358.246;left:132.145;"><nobr>
<span style="font-size:20.022;">if a PMP entry is configured to match the four-byte range 0xC – 0xF , then an 8-byte access to the</span>
</nobr></div>
<div style="position:absolute;top:383.115;left:132.145;"><nobr>
<span style="font-size:20.022;">range 0x8 – 0xF will fail, assuming that PMP entry is the highest-priority entry that matches those</span>
</nobr></div>
<div style="position:absolute;top:407.982;left:132.145;"><nobr>
<span style="font-size:20.022;">addresses.</span>
</nobr></div>
<div style="position:absolute;top:451.135;left:132.145;"><nobr>
<span style="font-size:20.022;">If a PMP entry matches all bytes of an access, then the L, R, W, and X bits determine whether the</span>
</nobr></div>
<div style="position:absolute;top:476.002;left:132.145;"><nobr>
<span style="font-size:20.022;">access succeeds or fails. If the L bit is clear and the privilege mode of the access is M, the access</span>
</nobr></div>
<div style="position:absolute;top:500.869;left:132.145;"><nobr>
<span style="font-size:20.022;">succeeds. Otherwise, if the L bit is set or the privilege mode of the access is S or U, then the access</span>
</nobr></div>
<div style="position:absolute;top:525.736;left:132.145;"><nobr>
<span style="font-size:20.022;">succeeds only if the R, W, or X bit corresponding to the access type is set.</span>
</nobr></div>
<div style="position:absolute;top:568.889;left:132.145;"><nobr>
<span style="font-size:20.022;">If no PMP entry matches an M-mode access, the access succeeds. If no PMP entry matches an</span>
</nobr></div>
<div style="position:absolute;top:593.756;left:132.145;"><nobr>
<span style="font-size:20.022;">S-mode or U-mode access, but at least one PMP entry is implemented, the access fails.</span>
</nobr></div>
<div style="position:absolute;top:636.909;left:132.145;"><nobr>
<span style="font-size:20.022;">Failed accesses generate a load, store, or instruction access exception. Note that a single instruction</span>
</nobr></div>
<div style="position:absolute;top:661.776;left:132.145;"><nobr>
<span style="font-size:20.022;">may generate multiple accesses, which may not be mutually atomic. An access exception is gen-</span>
</nobr></div>
<div style="position:absolute;top:686.643;left:132.145;"><nobr>
<span style="font-size:20.022;">erated if at least one access generated by an instruction fails, though other accesses generated by</span>
</nobr></div>
<div style="position:absolute;top:711.512;left:132.145;"><nobr>
<span style="font-size:20.022;">that instruction may succeed with visible side effects. Notably, instructions that reference virtual</span>
</nobr></div>
<div style="position:absolute;top:736.379;left:132.145;"><nobr>
<span style="font-size:20.022;">memory are decomposed into multiple accesses.</span>
</nobr></div>
<div style="position:absolute;top:779.532;left:132.145;"><nobr>
<span style="font-size:20.022;">On some implementations, misaligned loads, stores, and instruction fetches may also be decomposed</span>
</nobr></div>
<div style="position:absolute;top:804.399;left:132.145;"><nobr>
<span style="font-size:20.022;">into multiple accesses, some of which may succeed before an access exception occurs. In particular,</span>
</nobr></div>
<div style="position:absolute;top:829.267;left:132.145;"><nobr>
<span style="font-size:20.022;">a portion of a misaligned store that passes the PMP check may become visible, even if another</span>
</nobr></div>
<div style="position:absolute;top:854.134;left:132.145;"><nobr>
<span style="font-size:20.022;">portion fails the PMP check. The same behavior may manifest for floating-point stores wider than</span>
</nobr></div>
<div style="position:absolute;top:879.001;left:132.145;"><nobr>
<span style="font-size:20.022;">XLEN bits (e.g., the FSD instruction in RV32D), even when the store address is naturally aligned.</span>
</nobr></div>
<div style="position:absolute;top:950.363;left:132.145;"><nobr>
<span style="font-size:21.942;font-weight:bold;">3.6.2</span>
</nobr></div>
<div style="position:absolute;top:950.363;left:207.516;"><nobr>
<span style="font-size:21.942;font-weight:bold;">Physical Memory Protection and Paging</span>
</nobr></div>
<div style="position:absolute;top:1007.938;left:132.145;"><nobr>
<span style="font-size:20.022;">The Physical Memory Protection mechanism is designed to compose with the page-based virtual</span>
</nobr></div>
<div style="position:absolute;top:1032.805;left:132.145;"><nobr>
<span style="font-size:20.022;">memory systems described in Chapter</span>
<span style="font-size:20.022;color: #000080;"><a href="#" onClick="javascript:parent.GotoNewPage(66); return false">4</a></span>
<span style="font-size:20.022;">. When paging is enabled, instructions that access virtual</span>
</nobr></div>
<div style="position:absolute;top:1057.672;left:132.145;"><nobr>
<span style="font-size:20.022;">memory may result in multiple physical-memory accesses, including implicit references to the page</span>
</nobr></div>
<div style="position:absolute;top:1082.539;left:132.145;"><nobr>
<span style="font-size:20.022;">tables. The PMP checks apply to all of these accesses. The effective privilege mode for implicit</span>
</nobr></div>
<div style="position:absolute;top:1107.408;left:132.145;"><nobr>
<span style="font-size:20.022;">page-table accesses is S.</span>
</nobr></div>
<div style="position:absolute;top:1150.559;left:132.145;"><nobr>
<span style="font-size:20.022;">Implementations with virtual memory are permitted to perform address translations speculatively</span>
</nobr></div>
<div style="position:absolute;top:1175.428;left:132.145;"><nobr>
<span style="font-size:20.022;">and earlier than required by an explicit virtual-memory access. The PMP settings for the resulting</span>
</nobr></div>
<div style="position:absolute;top:1200.296;left:132.145;"><nobr>
<span style="font-size:20.022;">physical address may be checked at any point between the address translation and the explicit</span>
</nobr></div>
<div style="position:absolute;top:1225.163;left:132.145;"><nobr>
<span style="font-size:20.022;">virtual-memory access. Hence, when the PMP settings are modified in a manner that affects either</span>
</nobr></div>
<div style="position:absolute;top:1250.030;left:132.145;"><nobr>
<span style="font-size:20.022;">the physical memory that holds the page tables or the physical memory to which the page tables</span>
</nobr></div>
<div style="position:absolute;top:1274.897;left:132.145;"><nobr>
<span style="font-size:20.022;">point, M-mode software must synchronize the PMP settings with the virtual memory system. This</span>
</nobr></div>
<div style="position:absolute;top:1299.766;left:132.145;"><nobr>
<span style="font-size:20.022;">is accomplished by executing an SFENCE.VMA instruction with</span>
<span style="font-size:20.022;font-style:italic;">rs1</span>
<span style="font-size:20.022;">= x0 and</span>
<span style="font-size:20.022;font-style:italic;">rs2</span>
<span style="font-size:20.022;">= x0 , after the</span>
</nobr></div>
</td></tr>
</table>
