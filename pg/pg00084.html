<table border="0" height="1453" width="1123">
<tr><td>
<div style="position:absolute; top:0; left:0;"><img height="1453" width="1123"src="bgimg/bg00084.jpg"/></div>
<div style="position:absolute;top:74.119;left:132.145;"><nobr>
<span style="font-size:20.022;">72</span>
</nobr></div>
<div style="position:absolute;top:74.119;left:331.141;"><nobr>
<span style="font-size:20.022;font-style:italic;">Volume II: RISC-V Privileged Architectures V20190608-Priv-MSU-Ratified</span>
</nobr></div>
<div style="position:absolute;top:128.281;left:191.734;"><nobr>
<span style="font-size:14.628;">63</span>
</nobr></div>
<div style="position:absolute;top:128.281;left:265.692;"><nobr>
<span style="font-size:14.628;">54 53</span>
</nobr></div>
<div style="position:absolute;top:147.856;left:201.494;"><nobr>
<span style="font-size:16.456;font-style:italic;">Reserved</span>
</nobr></div>
<div style="position:absolute;top:147.856;left:301.669;"><nobr>
<span style="font-size:16.456;">PPN[2]</span>
</nobr></div>
<div style="position:absolute;top:168.702;left:225.210;"><nobr>
<span style="font-size:16.456;">10</span>
</nobr></div>
<div style="position:absolute;top:168.702;left:320.329;"><nobr>
<span style="font-size:16.456;">26</span>
</nobr></div>
<div style="position:absolute;top:128.281;left:360.818;"><nobr>
<span style="font-size:14.628;">28 27</span>
</nobr></div>
<div style="position:absolute;top:147.856;left:396.814;"><nobr>
<span style="font-size:16.456;">PPN[1]</span>
</nobr></div>
<div style="position:absolute;top:168.702;left:419.677;"><nobr>
<span style="font-size:16.456;">9</span>
</nobr></div>
<div style="position:absolute;top:128.281;left:455.943;"><nobr>
<span style="font-size:14.628;">19 18</span>
</nobr></div>
<div style="position:absolute;top:147.856;left:491.958;"><nobr>
<span style="font-size:16.456;">PPN[0]</span>
</nobr></div>
<div style="position:absolute;top:168.702;left:514.795;"><nobr>
<span style="font-size:16.456;">9</span>
</nobr></div>
<div style="position:absolute;top:128.281;left:551.068;"><nobr>
<span style="font-size:14.628;">10 9</span>
</nobr></div>
<div style="position:absolute;top:147.856;left:587.859;"><nobr>
<span style="font-size:16.456;">RSW</span>
</nobr></div>
<div style="position:absolute;top:168.702;left:598.032;"><nobr>
<span style="font-size:16.456;">2</span>
</nobr></div>
<div style="position:absolute;top:128.281;left:630.191;"><nobr>
<span style="font-size:14.628;">8</span>
</nobr></div>
<div style="position:absolute;top:128.281;left:662.840;"><nobr>
<span style="font-size:14.628;">7</span>
</nobr></div>
<div style="position:absolute;top:147.856;left:659.974;"><nobr>
<span style="font-size:16.456;">D</span>
</nobr></div>
<div style="position:absolute;top:168.702;left:662.459;"><nobr>
<span style="font-size:16.456;">1</span>
</nobr></div>
<div style="position:absolute;top:128.281;left:698.298;"><nobr>
<span style="font-size:14.628;">6</span>
</nobr></div>
<div style="position:absolute;top:147.856;left:695.565;"><nobr>
<span style="font-size:16.456;">A</span>
</nobr></div>
<div style="position:absolute;top:168.702;left:697.923;"><nobr>
<span style="font-size:16.456;">1</span>
</nobr></div>
<div style="position:absolute;top:128.281;left:733.947;"><nobr>
<span style="font-size:14.628;">5</span>
</nobr></div>
<div style="position:absolute;top:147.856;left:730.921;"><nobr>
<span style="font-size:16.456;">G</span>
</nobr></div>
<div style="position:absolute;top:168.702;left:733.568;"><nobr>
<span style="font-size:16.456;">1</span>
</nobr></div>
<div style="position:absolute;top:128.281;left:769.595;"><nobr>
<span style="font-size:14.628;">4</span>
</nobr></div>
<div style="position:absolute;top:147.856;left:766.866;"><nobr>
<span style="font-size:16.456;">U</span>
</nobr></div>
<div style="position:absolute;top:168.702;left:769.196;"><nobr>
<span style="font-size:16.456;">1</span>
</nobr></div>
<div style="position:absolute;top:128.281;left:804.951;"><nobr>
<span style="font-size:14.628;">3</span>
</nobr></div>
<div style="position:absolute;top:147.856;left:802.222;"><nobr>
<span style="font-size:16.456;">X</span>
</nobr></div>
<div style="position:absolute;top:168.702;left:804.544;"><nobr>
<span style="font-size:16.456;">1</span>
</nobr></div>
<div style="position:absolute;top:128.281;left:842.647;"><nobr>
<span style="font-size:14.628;">2</span>
</nobr></div>
<div style="position:absolute;top:147.856;left:837.579;"><nobr>
<span style="font-size:16.456;">W</span>
</nobr></div>
<div style="position:absolute;top:168.702;left:842.230;"><nobr>
<span style="font-size:16.456;">1</span>
</nobr></div>
<div style="position:absolute;top:128.281;left:880.226;"><nobr>
<span style="font-size:14.628;">1</span>
</nobr></div>
<div style="position:absolute;top:147.856;left:877.631;"><nobr>
<span style="font-size:16.456;">R</span>
</nobr></div>
<div style="position:absolute;top:168.702;left:879.800;"><nobr>
<span style="font-size:16.456;">1</span>
</nobr></div>
<div style="position:absolute;top:128.281;left:915.464;"><nobr>
<span style="font-size:14.628;">0</span>
</nobr></div>
<div style="position:absolute;top:147.856;left:912.755;"><nobr>
<span style="font-size:16.456;">V</span>
</nobr></div>
<div style="position:absolute;top:168.702;left:915.033;"><nobr>
<span style="font-size:16.456;">1</span>
</nobr></div>
<div style="position:absolute;top:215.006;left:407.642;"><nobr>
<span style="font-size:20.022;">Figure 4.18: Sv39 page table entry.</span>
</nobr></div>
<div style="position:absolute;top:271.814;left:132.145;"><nobr>
<span style="font-size:20.022;">Sv39 page tables contain 2</span>
<span style="font-size:14.628;">9</span>
<span style="font-size:20.022;">page table entries (PTEs), eight bytes each. A page table is exactly</span>
</nobr></div>
<div style="position:absolute;top:296.681;left:132.145;"><nobr>
<span style="font-size:20.022;">the size of a page and must always be aligned to a page boundary. The physical page number of</span>
</nobr></div>
<div style="position:absolute;top:321.548;left:132.145;"><nobr>
<span style="font-size:20.022;">the root page table is stored in the satp register’s PPN field.</span>
</nobr></div>
<div style="position:absolute;top:364.701;left:132.145;"><nobr>
<span style="font-size:20.022;">The PTE format for Sv39 is shown in Figure</span>
<span style="font-size:20.022;color: #000080;"><a href="#" onClick="javascript:parent.GotoNewPage(83); return false">4.18</a></span>
<span style="font-size:20.022;">. Bits 9–0 have the same meaning as for Sv32.</span>
</nobr></div>
<div style="position:absolute;top:389.568;left:132.145;"><nobr>
<span style="font-size:20.022;">Bits 63–54 are reserved for future use and must be zeroed by software for forward compatibility.</span>
</nobr></div>
<div style="position:absolute;top:442.802;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">We reserved several PTE bits for a possible extension that improves support for sparse address</span>
</nobr></div>
<div style="position:absolute;top:464.745;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">spaces by allowing page-table levels to be skipped, reducing memory usage and TLB refill latency.</span>
</nobr></div>
<div style="position:absolute;top:486.687;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">These reserved bits may also be used to facilitate research experimentation. The cost is reducing</span>
</nobr></div>
<div style="position:absolute;top:508.629;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">the physical address space, but 64 PiB is presently ample. When it no longer suffices, the reserved</span>
</nobr></div>
<div style="position:absolute;top:530.570;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">bits that remain unallocated could be used to expand the physical address space.</span>
</nobr></div>
<div style="position:absolute;top:562.377;left:132.145;"><nobr>
<span style="font-size:20.022;">Any level of PTE may be a leaf PTE, so in addition to 4 KiB pages, Sv39 supports 2 MiB</span>
<span style="font-size:20.022;font-style:italic;">megapages</span>
</nobr></div>
<div style="position:absolute;top:587.244;left:132.145;"><nobr>
<span style="font-size:20.022;">and 1 GiB</span>
<span style="font-size:20.022;font-style:italic;">gigapages</span>
<span style="font-size:20.022;">, each of which must be virtually and physically aligned to a boundary equal</span>
</nobr></div>
<div style="position:absolute;top:612.113;left:132.145;"><nobr>
<span style="font-size:20.022;">to its size. A page-fault exception is raised if the physical address is insufficiently aligned.</span>
</nobr></div>
<div style="position:absolute;top:655.264;left:132.145;"><nobr>
<span style="font-size:20.022;">The algorithm for virtual-to-physical address translation is the same as in Section</span>
<span style="font-size:20.022;color: #000080;"><a href="#" onClick="javascript:parent.GotoNewPage(81); return false">4.3.2</a></span>
<span style="font-size:20.022;">, except</span>
</nobr></div>
<div style="position:absolute;top:680.133;left:132.145;"><nobr>
<span style="font-size:20.022;">LEVELS equals 3 and PTESIZE equals 8.</span>
</nobr></div>
<div style="position:absolute;top:756.235;left:132.145;"><nobr>
<span style="font-size:26.330;font-weight:bold;">4.5</span>
</nobr></div>
<div style="position:absolute;top:756.235;left:199.577;"><nobr>
<span style="font-size:26.330;font-weight:bold;">Sv48: Page-Based 48-bit Virtual-Memory System</span>
</nobr></div>
<div style="position:absolute;top:823.593;left:132.145;"><nobr>
<span style="font-size:20.022;">This section describes a simple paged virtual-memory system designed for RV64 systems, which</span>
</nobr></div>
<div style="position:absolute;top:848.460;left:132.145;"><nobr>
<span style="font-size:20.022;">supports 48-bit virtual address spaces. Sv48 is intended for systems for which a 39-bit virtual</span>
</nobr></div>
<div style="position:absolute;top:873.329;left:132.145;"><nobr>
<span style="font-size:20.022;">address space is insufficient. It closely follows the design of Sv39, simply adding an additional level</span>
</nobr></div>
<div style="position:absolute;top:898.197;left:132.145;"><nobr>
<span style="font-size:20.022;">of page table, and so this chapter only details the differences between the two schemes.</span>
</nobr></div>
<div style="position:absolute;top:941.349;left:132.145;"><nobr>
<span style="font-size:20.022;">Implementations that support Sv48 must also support Sv39.</span>
</nobr></div>
<div style="position:absolute;top:994.583;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">Systems that support Sv48 can also support Sv39 at essentially no cost, and so should do so to</span>
</nobr></div>
<div style="position:absolute;top:1016.525;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">maintain compatibility with supervisor software that assumes Sv39.</span>
</nobr></div>
<div style="position:absolute;top:1074.860;left:132.145;"><nobr>
<span style="font-size:21.942;font-weight:bold;">4.5.1</span>
</nobr></div>
<div style="position:absolute;top:1074.860;left:207.516;"><nobr>
<span style="font-size:21.942;font-weight:bold;">Addressing and Memory Protection</span>
</nobr></div>
<div style="position:absolute;top:1132.275;left:132.145;"><nobr>
<span style="font-size:20.022;">Sv48 implementations support a 48-bit virtual address space, divided into 4 KiB pages. An Sv48</span>
</nobr></div>
<div style="position:absolute;top:1157.143;left:132.145;"><nobr>
<span style="font-size:20.022;">address is partitioned as shown in Figure</span>
<span style="font-size:20.022;color: #000080;"><a href="#" onClick="javascript:parent.GotoNewPage(84); return false">4.19</a></span>
<span style="font-size:20.022;">. Instruction fetch addresses and load and store</span>
</nobr></div>
<div style="position:absolute;top:1182.010;left:132.145;"><nobr>
<span style="font-size:20.022;">effective addresses, which are 64 bits, must have bits 63–48 all equal to bit 47, or else a page-fault</span>
</nobr></div>
<div style="position:absolute;top:1206.877;left:132.145;"><nobr>
<span style="font-size:20.022;">exception will occur. The 36-bit VPN is translated into a 44-bit PPN via a four-level page table,</span>
</nobr></div>
<div style="position:absolute;top:1231.746;left:132.145;"><nobr>
<span style="font-size:20.022;">while the 12-bit page offset is untranslated.</span>
</nobr></div>
<div style="position:absolute;top:1274.899;left:132.145;"><nobr>
<span style="font-size:20.022;">The PTE format for Sv48 is shown in Figure</span>
<span style="font-size:20.022;color: #000080;"><a href="#" onClick="javascript:parent.GotoNewPage(84); return false">4.21</a></span>
<span style="font-size:20.022;">. Bits 9–0 have the same meaning as for Sv32. Any</span>
</nobr></div>
<div style="position:absolute;top:1299.766;left:132.145;"><nobr>
<span style="font-size:20.022;">level of PTE may be a leaf PTE, so in addition to 4 KiB pages, Sv48 supports 2 MiB</span>
<span style="font-size:20.022;font-style:italic;">megapages</span>
<span style="font-size:20.022;">,</span>
</nobr></div>
</td></tr>
</table>
