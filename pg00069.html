<table border="0" height="1453" width="1123">
<tr><td>
<div style="position:absolute; top:0; left:0;"><img height="1453" width="1123"src="bgimg/bg00069.jpg"/></div>
<div style="position:absolute;top:74.119;left:132.145;"><nobr>
<span style="font-size:20.022;font-style:italic;">Volume II: RISC-V Privileged Architectures V20190608-Priv-MSU-Ratified</span>
</nobr></div>
<div style="position:absolute;top:74.119;left:971.067;"><nobr>
<span style="font-size:20.022;">57</span>
</nobr></div>
<div style="position:absolute;top:130.572;left:132.145;"><nobr>
<span style="font-size:20.022;">If UXLEN</span>
<span style="font-size:20.022;font-style:italic;">Ì¸</span>
<span style="font-size:20.022;">= SXLEN, instructions executed in the narrower mode must ignore source register</span>
</nobr></div>
<div style="position:absolute;top:155.440;left:132.145;"><nobr>
<span style="font-size:20.022;">operand bits above the configured XLEN, and must sign-extend results to fill the widest supported</span>
</nobr></div>
<div style="position:absolute;top:180.307;left:132.145;"><nobr>
<span style="font-size:20.022;">XLEN in the destination register.</span>
</nobr></div>
<div style="position:absolute;top:223.460;left:132.145;"><nobr>
<span style="font-size:20.022;">If UXLEN</span>
<span style="font-size:20.022;font-style:italic;">&lt;</span>
<span style="font-size:20.022;">SXLEN, user-mode instruction-fetch addresses and load and store effective addresses</span>
</nobr></div>
<div style="position:absolute;top:248.327;left:132.145;"><nobr>
<span style="font-size:20.022;">are taken modulo 2</span>
<span style="font-size:14.628;font-style:italic;">U XLEN</span>
<span style="font-size:20.022;">. For example, when UXLEN=32 and SXLEN=64, user-mode memory</span>
</nobr></div>
<div style="position:absolute;top:273.194;left:132.145;"><nobr>
<span style="font-size:20.022;">accesses reference the lowest 4 GiB of the address space.</span>
</nobr></div>
<div style="position:absolute;top:345.147;left:132.145;"><nobr>
<span style="font-size:21.942;font-weight:bold;">4.1.3</span>
</nobr></div>
<div style="position:absolute;top:345.147;left:207.516;"><nobr>
<span style="font-size:21.942;font-weight:bold;">Memory Privilege in</span>
<span style="font-size:21.942;">sstatus</span>
<span style="font-size:21.942;font-weight:bold;">Register</span>
</nobr></div>
<div style="position:absolute;top:402.839;left:132.145;"><nobr>
<span style="font-size:20.022;">The MXR (Make eXecutable Readable) bit modifies the privilege with which loads access virtual</span>
</nobr></div>
<div style="position:absolute;top:427.707;left:132.145;"><nobr>
<span style="font-size:20.022;">memory. When MXR=0, only loads from pages marked readable (R=1 in Figure</span>
<span style="font-size:20.022;color: #000080;"><a href="#" onClick="javascript:parent.GotoNewPage(79); return false">4.15</a></span>
<span style="font-size:20.022;">) will succeed.</span>
</nobr></div>
<div style="position:absolute;top:452.576;left:132.145;"><nobr>
<span style="font-size:20.022;">When MXR=1, loads from pages marked either readable or executable (R=1 or X=1) will succeed.</span>
</nobr></div>
<div style="position:absolute;top:477.443;left:132.145;"><nobr>
<span style="font-size:20.022;">MXR has no effect when page-based virtual memory is not in effect.</span>
</nobr></div>
<div style="position:absolute;top:520.596;left:132.145;"><nobr>
<span style="font-size:20.022;">The SUM (permit Supervisor User Memory access) bit modifies the privilege with which S-mode</span>
</nobr></div>
<div style="position:absolute;top:545.463;left:132.145;"><nobr>
<span style="font-size:20.022;">loads and stores access virtual memory. When SUM=0, S-mode memory accesses to pages that are</span>
</nobr></div>
<div style="position:absolute;top:570.330;left:132.145;"><nobr>
<span style="font-size:20.022;">accessible by U-mode (U=1 in Figure</span>
<span style="font-size:20.022;color: #000080;"><a href="#" onClick="javascript:parent.GotoNewPage(79); return false">4.15</a></span>
<span style="font-size:20.022;">) will fault. When SUM=1, these accesses are permitted.</span>
</nobr></div>
<div style="position:absolute;top:595.197;left:132.145;"><nobr>
<span style="font-size:20.022;">SUM has no effect when page-based virtual memory is not in effect, nor when executing in U-mode.</span>
</nobr></div>
<div style="position:absolute;top:620.064;left:132.145;"><nobr>
<span style="font-size:20.022;">Note that S-mode can never execute instructions from user pages, regardless of the state of SUM.</span>
</nobr></div>
<div style="position:absolute;top:680.421;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">The SUM mechanism prevents supervisor software from inadvertently accessing user memory.</span>
</nobr></div>
<div style="position:absolute;top:702.363;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">Operating systems can execute the majority of code with SUM clear; the few code segments that</span>
</nobr></div>
<div style="position:absolute;top:724.304;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">should access user memory can temporarily set SUM.</span>
</nobr></div>
<div style="position:absolute;top:746.540;left:212.233;"><nobr>
<span style="font-size:18.285;font-style:italic;">The SUM mechanism does not avail S-mode software of permission to execute instructions</span>
</nobr></div>
<div style="position:absolute;top:768.483;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">in user code pages. Legitimate uses cases for execution from user memory in supervisor context</span>
</nobr></div>
<div style="position:absolute;top:790.425;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">are rare in general and nonexistent in POSIX environments. However, bugs in supervisors that</span>
</nobr></div>
<div style="position:absolute;top:812.366;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">lead to arbitrary code execution are much easier to exploit if the supervisor exploit code can be</span>
</nobr></div>
<div style="position:absolute;top:834.308;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">stored in a user buffer at a virtual address chosen by an attacker.</span>
</nobr></div>
<div style="position:absolute;top:856.543;left:212.233;"><nobr>
<span style="font-size:18.285;font-style:italic;">Some non-POSIX single address space operating systems do allow certain privileged software</span>
</nobr></div>
<div style="position:absolute;top:878.485;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">to partially execute in supervisor mode, while most programs run in user mode, all in a shared</span>
</nobr></div>
<div style="position:absolute;top:900.428;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">address space. This use case can be realized by mapping the physical code pages at multiple</span>
</nobr></div>
<div style="position:absolute;top:922.370;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">virtual addresses with different permissions, possibly with the assistance of the instruction page-</span>
</nobr></div>
<div style="position:absolute;top:944.311;left:182.201;"><nobr>
<span style="font-size:18.285;font-style:italic;">fault handler to direct supervisor software to use the alternate mapping.</span>
</nobr></div>
<div style="position:absolute;top:1011.746;left:132.145;"><nobr>
<span style="font-size:21.942;font-weight:bold;">4.1.4</span>
</nobr></div>
<div style="position:absolute;top:1011.746;left:207.516;"><nobr>
<span style="font-size:21.942;font-weight:bold;">Supervisor Trap Vector Base Address Register (</span>
<span style="font-size:21.942;">stvec</span>
<span style="font-size:21.942;font-weight:bold;">)</span>
</nobr></div>
<div style="position:absolute;top:1069.438;left:132.145;"><nobr>
<span style="font-size:20.022;">The stvec register is an SXLEN-bit read/write register that holds trap vector configuration, con-</span>
</nobr></div>
<div style="position:absolute;top:1094.307;left:132.145;"><nobr>
<span style="font-size:20.022;">sisting of a vector base address (BASE) and a vector mode (MODE).</span>
</nobr></div>
<div style="position:absolute;top:1139.664;left:198.677;"><nobr>
<span style="font-size:14.628;">SXLEN-1</span>
</nobr></div>
<div style="position:absolute;top:1159.241;left:376.496;"><nobr>
<span style="font-size:16.456;">BASE[SXLEN-1:2] (</span>
<span style="font-size:16.456;font-weight:bold;">WARL</span>
<span style="font-size:16.456;">)</span>
</nobr></div>
<div style="position:absolute;top:1180.085;left:454.899;"><nobr>
<span style="font-size:16.456;">SXLEN-2</span>
</nobr></div>
<div style="position:absolute;top:1139.664;left:779.921;"><nobr>
<span style="font-size:14.628;">21</span>
</nobr></div>
<div style="position:absolute;top:1139.664;left:898.846;"><nobr>
<span style="font-size:14.628;">0</span>
</nobr></div>
<div style="position:absolute;top:1159.241;left:798.664;"><nobr>
<span style="font-size:16.456;">MODE (</span>
<span style="font-size:16.456;font-weight:bold;">WARL</span>
<span style="font-size:16.456;">)</span>
</nobr></div>
<div style="position:absolute;top:1180.085;left:842.877;"><nobr>
<span style="font-size:16.456;">2</span>
</nobr></div>
<div style="position:absolute;top:1227.501;left:278.028;"><nobr>
<span style="font-size:20.022;">Figure 4.3: Supervisor trap vector base address register ( stvec ).</span>
</nobr></div>
<div style="position:absolute;top:1274.899;left:132.145;"><nobr>
<span style="font-size:20.022;">The BASE field in stvec is a</span>
<span style="font-size:20.022;font-weight:bold;">WARL</span>
<span style="font-size:20.022;">field that can hold any valid virtual or physical address,</span>
</nobr></div>
<div style="position:absolute;top:1299.766;left:132.145;"><nobr>
<span style="font-size:20.022;">subject to the following alignment constraints: the address must be 4-byte aligned, and MODE</span>
</nobr></div>
</td></tr>
</table>
